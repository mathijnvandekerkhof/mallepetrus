# Docker Compose for Portainer deployment
services:
  jiptv-app:
    image: jiptv:latest
    container_name: jiptv-app
    environment:
      SPRING_PROFILES_ACTIVE: ${SPRING_PROFILES_ACTIVE:-prod}
      DB_HOST: ${DB_HOST:-jiptv-postgres}
      DB_PORT: 5432
      DB_NAME: jiptv
      DB_USER: jiptv
      DB_PASSWORD: ${DB_PASSWORD}
      REDIS_HOST: ${REDIS_HOST:-jiptv-redis}
      REDIS_PORT: 6379
      REDIS_PASSWORD: ${REDIS_PASSWORD}
      REDIS_DATABASE_GENERAL: ${REDIS_DATABASE_GENERAL:-0}
      REDIS_DATABASE_ZEROTRUST: ${REDIS_DATABASE_ZEROTRUST:-1}
      REDIS_DATABASE_RATELIMIT: ${REDIS_DATABASE_RATELIMIT:-2}
      JWT_SECRET: ${JWT_SECRET}
      ZERO_TRUST_ENABLED: ${ZERO_TRUST_ENABLED:-true}
      ZERO_TRUST_RISK_THRESHOLD: ${ZERO_TRUST_RISK_THRESHOLD:-75}
      ZERO_TRUST_MAX_DEVICES: ${ZERO_TRUST_MAX_DEVICES:-5}
      BREVO_SMTP_HOST: ${BREVO_SMTP_HOST}
      BREVO_SMTP_PORT: ${BREVO_SMTP_PORT:-587}
      BREVO_SMTP_USER: ${BREVO_SMTP_USER}
      BREVO_SMTP_PASSWORD: ${BREVO_SMTP_PASSWORD}
      MAIL_FROM: ${MAIL_FROM}
      ADMIN_DOMAIN: ${ADMIN_DOMAIN}
      USER_DOMAIN: ${USER_DOMAIN}
      API_DOMAIN: ${API_DOMAIN}
      # FFmpeg and transcoding configuration
      FFMPEG_PATH: ${FFMPEG_PATH:-ffmpeg}
      FFPROBE_PATH: ${FFPROBE_PATH:-ffprobe}
      FFMPEG_TIMEOUT: ${FFMPEG_TIMEOUT:-3600}
      TRANSCODING_OUTPUT_DIR: ${TRANSCODING_OUTPUT_DIR:-/app/transcoded}
      TRANSCODING_MAX_CONCURRENT_JOBS: ${TRANSCODING_MAX_CONCURRENT_JOBS:-2}
      TRANSCODING_JOB_TIMEOUT_HOURS: ${TRANSCODING_JOB_TIMEOUT_HOURS:-4}
      TRANSCODING_CLEANUP_DAYS: ${TRANSCODING_CLEANUP_DAYS:-7}
      HLS_SEGMENT_DURATION: ${HLS_SEGMENT_DURATION:-6}
    volumes:
      # Persistent storage for transcoded files
      - jiptv-transcoded:/app/transcoded
      # Optional: Mount external media directory
      # - ${MEDIA_PATH:-/media}:/media:ro
    networks:
      - default
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/api/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    deploy:
      resources:
        limits:
          memory: 2G
          cpus: '2.0'
        reservations:
          memory: 1G
          cpus: '1.0'
    labels:
      - "nginx-proxy-manager.enable=true"

volumes:
  jiptv-transcoded:
    driver: local

networks:
  default:
    name: mallepetrus_default
    external: true